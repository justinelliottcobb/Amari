#!/bin/bash

# Pre-commit hook for Amari: Enforce all tests pass before commits
# This is critical for a mathematical library to maintain correctness

set -e  # Exit on any command failure

echo "ğŸ§ª Running Amari pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸ“ Checking code formatting...${NC}"
if ! cargo fmt --check; then
    echo -e "${RED}âŒ Code formatting check failed!${NC}"
    echo "Run 'cargo fmt' to fix formatting issues"
    exit 1
fi
echo -e "${GREEN}âœ… Code formatting is correct${NC}"

echo -e "${YELLOW}ğŸ” Running Clippy lints...${NC}"
if ! cargo clippy --workspace --all-targets --all-features -- -D warnings; then
    echo -e "${RED}âŒ Clippy found issues!${NC}"
    echo "Fix the warnings above before committing"
    exit 1
fi
echo -e "${GREEN}âœ… Clippy checks passed${NC}"

echo -e "${YELLOW}ğŸ§ª Running core mathematical tests...${NC}"
if ! cargo test --workspace --quiet; then
    echo -e "${RED}âŒ Core tests failed!${NC}"
    echo "All tests must pass before committing to maintain mathematical correctness"
    exit 1
fi
echo -e "${GREEN}âœ… Core tests passed${NC}"

echo -e "${YELLOW}ğŸ”¬ Running formal verification tests...${NC}"
if ! cargo test --workspace --features formal-verification --quiet; then
    echo -e "${RED}âŒ Formal verification tests failed!${NC}"
    echo "Formal verification is critical for mathematical correctness"
    exit 1
fi
echo -e "${GREEN}âœ… Formal verification tests passed${NC}"

echo -e "${YELLOW}ğŸ“š Checking documentation builds...${NC}"
if ! cargo doc --workspace --no-deps --quiet; then
    echo -e "${RED}âŒ Documentation build failed!${NC}"
    echo "Fix documentation issues before committing"
    exit 1
fi
echo -e "${GREEN}âœ… Documentation builds successfully${NC}"

echo -e "${GREEN}ğŸ‰ All pre-commit checks passed! Proceeding with commit...${NC}"
echo ""
echo "âœ¨ Mathematical correctness maintained âœ¨"